<html>
<head><title>Booking Form</title></head>
<body>

<?php
// Set up the database connection and get a list of the members
include("../.mysql.php");
$conn = mysqli_connect($servername, $username, $password);
@mysqli_select_db($conn, "arrowsreach_db") or die("Unable to select database");


	if ($REQUEST_METHOD == "POST")
	{
		// Check the submitted values
		$query = "SELECT DISTINCT m.member_id, m.first_name, m.last_name
					FROM edelweiss_members AS m
					WHERE m.member_id = $member_id ";

		$result = mysqli_query($conn, $query);
		$m_id = mysqli_result($result, 0, "member_id");
		$m_first = mysqli_result($result, $i, "first_name");
		$m_last = mysqli_result($result, $i, "last_name");

		// Display the submitted values
		echo "Member ID: $m_id <br>";
		echo "Member : $m_first $m_last<br>";
		echo "Start : $date_day / $date_month / $date_year <br>";
		echo "Duration (days): $length <br>";
		echo "Number Members: $num_members <br>";
		echo "Number Guests: $num_guests <br>";
		$total_booked = $num_members + $num_guests;
		echo "Total Booked: $total_booked <br>";
		$payment = 16.50 * $num_members + 33.00 * $num_guests;
		printf("Payment Due : \$%01.2f <br>", $payment);

		$mail_body  = "$m_first $m_last ($m_id)\n ";
		$mail_body .= "$date_day / $date_month / $date_year\n";
		$mail_body .= "$length days\n";
		$mail_body .= "Members=$num_members \nGuests=$num_guests \nTotal=$total_booked\n";
		$mail_body .= sprintf("Payment Due : \$%01.2f", $payment);

		$mail_header  = "From: \"Edelweiss Bookings\"  edelweiss@arrowsreach.com\r\n";
		$mail_header .= "Reply-to: edelweiss@arrowsreach.com\r\n";
		$mail_header .= "Return-path: edelweiss@arrowsreach.com\r\n";

		if ( mail("edelweiss@arrowsreach.com", "Booking for $m_first $m_last ($m_id)",
			$mail_body, $mail_header))
			{
				echo "<p><b>Mail Sent</b>";
			}
	}
	else
	{
		// Display the Form
		$query = "SELECT DISTINCT m.member_id, m.first_name, m.last_name
					FROM edelweiss_members AS m
					WHERE m.membership_type != 'Junior' AND m.membership_type != 'Spouse'
					ORDER BY m.last_name";

		$result = mysqli_query($conn, $query);

		$row_count = mysqli_num_rows($result);

?>
<h2>Booking Form</h2>

<form action="booking_form.php" method="post" >
  <table width="100%">
    <tr>
		<td>Member Name:</td>
		<td><select name="member_id">
			<? for ($i = 0; $i < $row_count; $i++)
				{
					$m_id = mysqli_result($result, $i, "member_id");
					$m_first = mysqli_result($result, $i, "first_name");
					$m_last = mysqli_result($result, $i, "last_name");

					echo "<option value=\"$m_id\">$m_first $m_last</option>";
				}
			?>
			</select>
		</td>
	</tr>
    <tr>
		<td>Booking Start Date:</td>
		<td><select name="date_day">
			<? for ($i = 1; $i <= 31; $i++)
				echo "<option value=\"$i\">$i</option>";
			?> </select>
			<select name="date_month">
			<? for ($i = 1; $i <= 12; $i++)
				echo "<option value=\"$i\">$i</option>";
			?> </select>
			<select name="date_year">
			<option value="2004">2004</option>
			</select>
			</td>
	</tr>
    <tr>
		<td>Booking Length:</td>
		<td><input type="text" name="length" maxlength="2" size="2" value="<?php echo "$length" ?>" /></td>
	</tr>
    <tr>
		<td>Number of Members :</td>
		<td><input type="text" name="num_members" maxlength="2" size="2" value="<?php echo "$num_members" ?>" /></td>
	</tr>
    <tr>
		<td>Number of Members :</td>
		<td><input type="text" name="num_guests" maxlength="2" size="2" value="<?php echo "$num_guests" ?>" /></td>
	</tr>
    <tr>
		<td align="center"></td>
		<td><input type="submit" /></td>
	</tr>
  </table>
</form>

<?

	} // else
?>

</body>
</html>

